<div class="page">
  <section class="panel">
    <div class="panel-header">
      <div>
        <h3>Costs</h3>
        <p class="panel-subtitle">Totals per category with included transactions.</p>
      </div>
      <span class="badge">{{ costs.length }} categories</span>
    </div>
    <div *ngFor="let cost of costs" class="cost-group">
      <details>
        <summary>
          <span class="cost-name">{{ cost.name }}</span>
          <span class="cost-meta">
            <span class="badge subtle">{{ cost.items.length }} items</span>
            <span class="cost-total">{{ cost.total }}</span>
            <button
              type="button"
              class="copy-button"
              (click)="copyTotal(cost.total)"
              title="Copy total"
            >
              Copy
            </button>
          </span>
        </summary>
        <table *ngIf="cost.items.length" class="data-table">
          <thead>
            <tr>
              <th>Description</th>
              <th class="amount-col">Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of cost.items">
              <td>{{ item.description || '—' }}</td>
              <td class="amount-col">{{ item.amount }}</td>
            </tr>
          </tbody>
        </table>
        <div *ngIf="!cost.items.length" class="empty-items">
          No matching items found.
        </div>
      </details>
    </div>
  </section>

  <section class="panel">
    <div class="panel-header">
      <div>
        <h3>Unmatched Costs</h3>
        <p class="panel-subtitle">Assign categories and add matching keywords.</p>
      </div>
      <span class="badge">{{ filteredUnmatchedCosts.length }} rows • {{ unmatchedTotal | number: '1.2-2' }}</span>
    </div>
    <div class="category-create">
      <input
        type="text"
        [(ngModel)]="newCategoryName"
        placeholder="New category name"
      />
      <button
        type="button"
        class="primary"
        (click)="createCategory()"
        [disabled]="isCreatingCategory"
      >
        Add category
      </button>
      <span *ngIf="categoryError" class="status error">{{ categoryError }}</span>
    </div>
    <div class="unmatched-controls">
      <input type="text" [(ngModel)]="filterText" placeholder="Filter by description" />
      <label class="toggle">
        <input type="checkbox" [(ngModel)]="hideCategorized" />
        Hide categorized
      </label>
    </div>
    <table *ngIf="filteredUnmatchedCosts.length" class="data-table">
      <thead>
        <tr>
          <th>Description</th>
          <th class="amount-col">Amount</th>
          <th>Category</th>
          <th>Keyword</th>
          <th>Action</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let unmatchedCost of filteredUnmatchedCosts">
          <td>{{ unmatchedCost.description }}</td>
          <td class="amount-col">{{ unmatchedCost.amount }}</td>
          <td>
            <select [(ngModel)]="unmatchedCost.selectedCategory">
              <option *ngFor="let category of categories" [value]="category">
                {{ category }}
              </option>
            </select>
          </td>
          <td>
            <input type="text" [(ngModel)]="unmatchedCost.keyword" placeholder="Match keyword" />
          </td>
          <td>
            <button
              type="button"
              class="primary"
              (click)="categorizeCost(unmatchedCost)"
              [disabled]="unmatchedCost.isSaving"
            >
              Categorize
            </button>
          </td>
          <td>
            <span *ngIf="unmatchedCost.categorized" class="status success">Saved</span>
            <span *ngIf="unmatchedCost.error" class="status error">{{ unmatchedCost.error }}</span>
          </td>
        </tr>
      </tbody>
    </table>
    <div *ngIf="!filteredUnmatchedCosts.length" class="empty-items">
      No unmatched costs.
    </div>
  </section>

  <section class="panel">
    <div class="panel-header">
      <div>
        <h3>Category Editor</h3>
        <p class="panel-subtitle">Manage keywords per category.</p>
      </div>
    </div>
    <div class="editor-controls">
      <select [(ngModel)]="editorCategory" (ngModelChange)="fetchCategoryKeywords()">
        <option *ngFor="let category of categories" [value]="category">
          {{ category }}
        </option>
      </select>
      <input
        type="text"
        [(ngModel)]="editorKeyword"
        placeholder="Add keyword to selected category"
      />
      <button
        type="button"
        class="primary"
        (click)="addEditorKeyword()"
        [disabled]="isSavingEditor"
      >
        Add keyword
      </button>
      <span *ngIf="editorError" class="status error">{{ editorError }}</span>
    </div>
    <div class="editor-grid" *ngIf="!isLoadingEditor">
      <div class="editor-column">
        <h4>Keywords</h4>
        <ul class="keyword-list">
          <li *ngFor="let keyword of editorKeywords">
            <span>{{ keyword }}</span>
            <button
              type="button"
              class="ghost"
              (click)="removeKeyword(keyword)"
              [disabled]="isDeletingEditor"
            >
              Remove
            </button>
          </li>
        </ul>
        <p class="editor-note" *ngIf="!editorKeywords.length">No keywords yet.</p>
      </div>
    </div>
    <div *ngIf="isLoadingEditor" class="empty-items">Loading keywords...</div>
    <div class="export-controls">
      <select [(ngModel)]="selectedSheetTab" [disabled]="!sheetTabs.length">
        <option *ngFor="let tab of sheetTabs" [value]="tab">
          {{ tab }}
        </option>
      </select>
      <button
        type="button"
        class="primary"
        (click)="exportToSheet()"
        [disabled]="isExporting"
      >
        Export to Google Sheets
      </button>
      <button
        type="button"
        class="ghost"
        (click)="connectGoogle()"
      >
        Connect Google
      </button>
      <span *ngIf="exportMessage" class="editor-note">{{ exportMessage }}</span>
    </div>
    <div *ngIf="exportAvailableLabels.length" class="editor-note">
      Available labels (first 100): {{ exportAvailableLabels.join(', ') }}
    </div>
  </section>
</div>